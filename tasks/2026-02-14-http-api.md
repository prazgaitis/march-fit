# HTTP API for Challenges

**Date:** 2026-02-14
**Description:** Add a RESTful HTTP API to the Convex backend for managing challenges, activities, users, leaderboard, and admin functionality. Designed with CLI and MCP server as the next consumers.

## Design Decisions

### API Key Scope
- [x] API keys are **user-scoped**, not challenge-scoped. A single key identifies a user across all challenges.
- [x] Authorization is checked per-request: users can only edit their own activities, admins get elevated privileges per-challenge.
- Rationale: CLI users want one key. Challenge-level permissions are already enforced by the existing role system (global admin, challenge creator, challenge admin role in userChallenges).

### API Key Storage
- [x] New `apiKeys` table: userId, keyHash (SHA-256), keyPrefix (first 8 chars for display), name, createdAt, lastUsedAt, revokedAt
- [x] Raw key shown once on creation, never stored
- [x] Keys are validated by hashing the provided key and looking up the hash

### Authentication
- [x] `Authorization: Bearer <api-key>` header
- [x] API key creation uses the existing session auth (web UI only)
- [x] All other API endpoints use API key auth

### Route Structure
All routes under `/api/v1/` prefix, returning JSON responses.

## API Endpoints

### Auth / API Keys (session-auth for create/list/revoke)
- [x] `POST /api/v1/auth/api-keys` - Create new API key
- [x] `GET /api/v1/auth/api-keys` - List API keys (masked)
- [x] `DELETE /api/v1/auth/api-keys/{keyId}` - Revoke API key

### User (API key auth)
- [x] `GET /api/v1/me` - Get current user profile

### Challenges
- [x] `GET /api/v1/challenges` - List user's challenges
- [x] `GET /api/v1/challenges/{id}` - Get challenge details
- [x] `POST /api/v1/challenges` - Create challenge
- [x] `PATCH /api/v1/challenges/{id}` - Update challenge (admin only)

### Activity Types
- [x] `GET /api/v1/challenges/{id}/activity-types` - List activity types

### Activities
- [x] `GET /api/v1/challenges/{id}/activities` - List activities (feed)
- [x] `POST /api/v1/challenges/{id}/activities` - Log activity
- [x] `GET /api/v1/activities/{id}` - Get activity details
- [x] `DELETE /api/v1/activities/{id}` - Delete activity (own or admin)

### Leaderboard
- [x] `GET /api/v1/challenges/{id}/leaderboard` - Get leaderboard

### Participants
- [x] `GET /api/v1/challenges/{id}/participants` - List participants

### Admin
- [x] `PUT /api/v1/challenges/{id}/announcement` - Set announcement
- [x] `GET /api/v1/challenges/{id}/flagged` - List flagged activities
- [x] `GET /api/v1/flagged/{activityId}` - Get flagged activity detail
- [x] `POST /api/v1/flagged/{activityId}/resolve` - Resolve flagged activity
- [x] `POST /api/v1/flagged/{activityId}/comment` - Add admin comment
- [x] `PATCH /api/v1/admin/activities/{id}` - Admin edit activity

## Frontend
- [x] Add collapsible "API Access" section to profile page with:
  - API key creation
  - List of existing keys with revoke button
  - Link to API documentation (GitHub readme placeholder)

## Implementation Notes
- HTTP actions in Convex use `httpAction` which provides `ctx` with `runQuery`, `runMutation`, `runAction`
- All business logic delegated to existing queries/mutations via internal functions where needed
- New internal queries/mutations added for API key operations
